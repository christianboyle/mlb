export const AL_EAST_TEAMS = [
  {
    name: 'Baltimore Orioles',
    teamId: '1',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/bal.png',
    color: 'DF4601'
  },
  {
    name: 'Boston Red Sox',
    teamId: '2',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/bos.png',
    color: 'BD3039'
  },
  {
    name: 'New York Yankees',
    teamId: '10',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/nyy.png',
    color: '003087'
  },
  {
    name: 'Tampa Bay Rays',
    teamId: '30',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/tb.png',
    color: '092C5C'
  },
  {
    name: 'Toronto Blue Jays',
    teamId: '14',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/tor.png',
    color: '134A8E'
  }
];

export const AL_CENTRAL_TEAMS = [
  {
    name: 'Chicago White Sox',
    teamId: '4',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/chw.png',
    color: '000000'
  },
  {
    name: 'Cleveland Guardians',
    teamId: '5',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/cle.png',
    color: 'E31937'
  },
  {
    name: 'Detroit Tigers',
    teamId: '6',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/det.png',
    color: '0C2340'
  },
  {
    name: 'Kansas City Royals',
    teamId: '7',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/kc.png',
    color: '004687'
  },
  {
    name: 'Minnesota Twins',
    teamId: '9',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/min.png',
    color: '002B5C'
  }
];

export const AL_WEST_TEAMS = [
  {
    name: 'Houston Astros',
    teamId: '18',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/hou.png',
    color: '002D62'
  },
  {
    name: 'Los Angeles Angels',
    teamId: '3',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/laa.png',
    color: 'BA0021'
  },
  {
    name: 'Oakland Athletics',
    teamId: '11',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/oak.png',
    color: '003831'
  },
  {
    name: 'Seattle Mariners',
    teamId: '12',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/sea.png',
    color: '0C2C56'
  },
  {
    name: 'Texas Rangers',
    teamId: '13',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/tex.png',
    color: '003278'
  }
];

export const NL_EAST_TEAMS = [
  {
    name: 'Atlanta Braves',
    teamId: '15',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/atl.png',
    color: 'CE1141'
  },
  {
    name: 'Miami Marlins',
    teamId: '28',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/mia.png',
    color: '00A3E0'
  },
  {
    name: 'New York Mets',
    teamId: '21',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/nym.png',
    color: 'FF5910'
  },
  {
    name: 'Philadelphia Phillies',
    teamId: '22',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/phi.png',
    color: 'E81828'
  },
  {
    name: 'Washington Nationals',
    teamId: '20',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/wsh.png',
    color: 'AB0003'
  }
];

export const NL_CENTRAL_TEAMS = [
  {
    name: 'Chicago Cubs',
    teamId: '16',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/chc.png',
    color: '0E3386'
  },
  {
    name: 'Cincinnati Reds',
    teamId: '17',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/cin.png',
    color: 'C6011F'
  },
  {
    name: 'Milwaukee Brewers',
    teamId: '8',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/mil.png',
    color: '12284B'
  },
  {
    name: 'Pittsburgh Pirates',
    teamId: '23',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/pit.png',
    color: '000000'
  },
  {
    name: 'St. Louis Cardinals',
    teamId: '24',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/stl.png',
    color: 'C41E3A'
  }
];

export const NL_WEST_TEAMS = [
  {
    name: 'Arizona Diamondbacks',
    teamId: '29',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/ari.png',
    color: 'A71930'
  },
  {
    name: 'Colorado Rockies',
    teamId: '27',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/col.png',
    color: '333366'
  },
  {
    name: 'Los Angeles Dodgers',
    teamId: '19',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/lad.png',
    color: '005A9C'
  },
  {
    name: 'San Diego Padres',
    teamId: '25',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/sd.png',
    color: '2F241D'
  },
  {
    name: 'San Francisco Giants',
    teamId: '26',
    logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/sf.png',
    color: 'FD5A1E'
  }
];

export const ALL_TEAMS = [
  ...AL_EAST_TEAMS,
  ...AL_CENTRAL_TEAMS,
  ...AL_WEST_TEAMS,
  ...NL_EAST_TEAMS,
  ...NL_CENTRAL_TEAMS,
  ...NL_WEST_TEAMS
];

export const CURRENT_SEASON = 2025;
export const DISPLAY_YEAR = 2025;

// Helper function to fetch games by season type
async function fetchGames(teamId, season, type) {
  const seasonType = type === 'spr' ? 1 : type === 'reg' ? 2 : 3;
  const res = await fetch(
    `https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/teams/${teamId}/schedule?season=${season}&seasontype=${seasonType}`
  );
  return res.json();
}

export async function getScores(teamId, season) {
  try {
    // For 2025, show spring training games only if we're not past opening day
    if (season === 2025 && !isPastOpeningDay(season)) {
      const springRes = await fetch(
        `https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/teams/${teamId}/schedule?season=${season}&seasontype=1`
      );
      const springData = await springRes.json();

      return {
        events: [
          // Spring Training games
          ...(springData.events?.map(event => ({
            id: event.id,
            name: event.name,
            date: new Date(event.date),
            status: event.status?.type?.name,
            isPostseason: false,
            isSpringTraining: true,
            competitions: event.competitions?.map(comp => {
              // Check for ties - equal scores and both teams have winner: false
              const scores = comp.competitors?.map(t => t.score?.value);
              const allWinnersFalse = comp.competitors?.every(t => t.winner === false);
              const isTie = scores?.length === 2 && scores[0] === scores[1] && allWinnersFalse;

              return {
                competitors: comp.competitors?.map(team => ({
                  score: team.score?.displayValue || '-',
                  winner: isTie ? null : team.winner,
                  homeAway: team.homeAway,
                  team: {
                    name: team.team?.displayName || team.team?.name,
                    logo: team.team?.logo || `https://a.espncdn.com/i/teamlogos/mlb/500/${team.team?.abbreviation?.toLowerCase()}.png`,
                    id: team.team?.id
                  }
                }))
              };
            })?.[0]
          })) || [])
        ]
      };
    }

    // For other seasons or after opening day, fetch all game types
    // Fetch spring training games
    const springRes = await fetch(
      `https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/teams/${teamId}/schedule?season=${season}&seasontype=1`
    );
    const springData = await springRes.json();
    
    // Fetch regular season games
    const regularRes = await fetch(
      `https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/teams/${teamId}/schedule?season=${season}&seasontype=2`
    );
    const regularData = await regularRes.json();

    // Group games by date to identify double-headers
    const gamesByDate = {};
    regularData.events?.forEach(e => {
      const date = new Date(e.date).toLocaleDateString();
      if (!gamesByDate[date]) {
        gamesByDate[date] = [];
      }
      gamesByDate[date].push(e.id);
    });

    // Fetch postseason games
    const postRes = await fetch(
      `https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/teams/${teamId}/schedule?season=${season}&seasontype=3`
    );
    const postData = await postRes.json();

    // Transform the data to match our needs
    const transformedData = {
      events: [
        // Spring Training games
        ...(springData.events?.map(event => ({
          id: event.id,
          name: event.name,
          date: new Date(event.date),
          status: event.status?.type?.name,
          isPostseason: false,
          isSpringTraining: true,
          competitions: event.competitions?.map(comp => {
            // Check for ties - equal scores and both teams have winner: false
            const scores = comp.competitors?.map(t => t.score?.value);
            const allWinnersFalse = comp.competitors?.every(t => t.winner === false);
            const isTie = scores?.length === 2 && scores[0] === scores[1] && allWinnersFalse;

            return {
              competitors: comp.competitors?.map(team => ({
                score: team.score?.displayValue || '-',
                winner: isTie ? null : team.winner,
                homeAway: team.homeAway,
                team: {
                  name: team.team?.displayName || team.team?.name,
                  logo: team.team?.logo || `https://a.espncdn.com/i/teamlogos/mlb/500/${team.team?.abbreviation?.toLowerCase()}.png`,
                  id: team.team?.id
                }
              }))
            };
          })?.[0]
        })) || []),
        // Regular Season games
        ...(regularData.events?.map(event => ({
          id: event.id,
          name: event.name,
          date: new Date(event.date),
          status: event.status?.type?.name,
          isPostseason: false,
          isSpringTraining: false,
          isDoubleHeader: gamesByDate[new Date(event.date).toLocaleDateString()].length > 1,
          competitions: event.competitions?.map(comp => {
            // Check for ties - equal scores and both teams have winner: false
            const scores = comp.competitors?.map(t => t.score?.value);
            const allWinnersFalse = comp.competitors?.every(t => t.winner === false);
            const isTie = scores?.length === 2 && scores[0] === scores[1] && allWinnersFalse;

            return {
              competitors: comp.competitors?.map(team => ({
                score: team.score?.displayValue || '-',
                winner: isTie ? null : team.winner,
                homeAway: team.homeAway,
                team: {
                  name: team.team?.displayName || team.team?.name,
                  logo: team.team?.logo || `https://a.espncdn.com/i/teamlogos/mlb/500/${team.team?.abbreviation?.toLowerCase()}.png`,
                  id: team.team?.id
                }
              }))
            };
          })?.[0]
        })) || []),
        // Postseason games
        ...(postData.events?.map(event => ({
          id: event.id,
          name: event.name,
          date: new Date(event.date),
          status: event.status?.type?.name,
          isPostseason: true,
          isSpringTraining: false,
          competitions: event.competitions?.map(comp => {
            // Check for ties - equal scores and both teams have winner: false
            const scores = comp.competitors?.map(t => t.score?.value);
            const allWinnersFalse = comp.competitors?.every(t => t.winner === false);
            const isTie = scores?.length === 2 && scores[0] === scores[1] && allWinnersFalse;

            return {
              competitors: comp.competitors?.map(team => ({
                score: team.score?.displayValue || '-',
                winner: isTie ? null : team.winner,
                homeAway: team.homeAway,
                team: {
                  name: team.team?.displayName || team.team?.name,
                  logo: team.team?.logo || `https://a.espncdn.com/i/teamlogos/mlb/500/${team.team?.abbreviation?.toLowerCase()}.png`,
                  id: team.team?.id
                }
              }))
            };
          })?.[0]
        })) || [])
      ]
        // Remove duplicates based on event ID
        .filter((event, index, self) => 
          index === self.findIndex((e) => e.id === event.id)
        )
        .sort((a, b) => b.date - a.date)
    };

    return transformedData;
  } catch (error) {
    console.error('Failed to fetch scores');
    throw error;
  }
}

export async function getTeamRecord(teamId, season) {
  try {
    // Convert season to a number for consistent comparison
    const seasonNum = parseInt(season);
    
    // For 2025, show spring training record only if we're not past opening day
    if (seasonNum === 2025 && !isPastOpeningDay(season)) {
      const springRes = await fetch(
        `https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/teams/${teamId}/schedule?season=${seasonNum}&seasontype=1`
      );
      const springData = await springRes.json();

      // Calculate spring training record
      let wins = 0;
      let losses = 0;
      let ties = 0;

      springData.events?.forEach(event => {
        const teamInGame = event.competitions?.[0]?.competitors?.find(
          c => c.team?.id === teamId
        );
        const otherTeam = event.competitions?.[0]?.competitors?.find(
          c => c.team?.id !== teamId
        );

        if (teamInGame && otherTeam) {
          // Check for tie - both teams have same score and winner: false
          const isTie = teamInGame.score?.value === otherTeam.score?.value && 
                       teamInGame.winner === false && 
                       otherTeam.winner === false;

          if (isTie) ties++;
          else if (teamInGame.winner === true) wins++;
          else if (teamInGame.winner === false) losses++;
        }
      });

      return {
        record: `${wins}-${losses}${ties > 0 ? `-${ties}` : ''}`,
        standing: 'Spring Training'
      };
    }

    // Get all division standings to determine position
    const standings = await getDivisionStandings(season, teamId);
    const teamStanding = standings.find(team => team.id === teamId);

    return {
      record: teamStanding?.record || '0-0',
      standing: teamStanding?.standingSummary || ''
    };
  } catch (error) {
    console.error('Error fetching team record:', error);
    return {
      record: '0-0',
      standing: ''
    };
  }
}

export async function getDivisionStandings(season, teamId, showSpringTraining = false) {
  try {
    // Convert season to a number for comparison
    const seasonNum = parseInt(season);
    
    // Determine which division the team belongs to
    let divisionTeams;
    let divisionName;
    
    if (AL_EAST_TEAMS.some(team => team.teamId === teamId)) {
      divisionTeams = AL_EAST_TEAMS;
      divisionName = 'AL East';
    } else if (AL_CENTRAL_TEAMS.some(team => team.teamId === teamId)) {
      divisionTeams = AL_CENTRAL_TEAMS;
      divisionName = 'AL Cent';
    } else if (AL_WEST_TEAMS.some(team => team.teamId === teamId)) {
      divisionTeams = AL_WEST_TEAMS;
      divisionName = 'AL West';
    } else if (NL_EAST_TEAMS.some(team => team.teamId === teamId)) {
      divisionTeams = NL_EAST_TEAMS;
      divisionName = 'NL East';
    } else if (NL_CENTRAL_TEAMS.some(team => team.teamId === teamId)) {
      divisionTeams = NL_CENTRAL_TEAMS;
      divisionName = 'NL Cent';
    } else if (NL_WEST_TEAMS.some(team => team.teamId === teamId)) {
      divisionTeams = NL_WEST_TEAMS;
      divisionName = 'NL West';
    } else {
      throw new Error('Team not found in any division');
    }

    // For 2025 and spring training toggle on, show spring training standings
    // Make sure showSpringTraining is true for 2025
    const shouldShowSpringTraining = (seasonNum === 2025) ? showSpringTraining : false;
    
    // Fetch each team's record
    const teamPromises = divisionTeams.map(async (team) => {
      if (shouldShowSpringTraining) {
        // For spring training, reuse the getTeamRecord function logic
        // This is the same calculation that works in the scores column
        const springRes = await fetch(
          `https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/teams/${team.teamId}/schedule?season=${seasonNum}&seasontype=1`
        );
        const springData = await springRes.json();
        
        // Calculate spring training record
        let wins = 0;
        let losses = 0;
        let ties = 0;
        
        springData.events?.forEach(event => {
          const teamInGame = event.competitions?.[0]?.competitors?.find(
            c => c.team?.id === team.teamId
          );
          const otherTeam = event.competitions?.[0]?.competitors?.find(
            c => c.team?.id !== team.teamId
          );
          
          if (teamInGame && otherTeam) {
            // Check for tie - both teams have same score and winner: false
            const isTie = teamInGame.score?.value === otherTeam.score?.value && 
                         teamInGame.winner === false && 
                         otherTeam.winner === false;
            
            if (isTie) ties++;
            else if (teamInGame.winner === true) wins++;
            else if (teamInGame.winner === false) losses++;
          }
        });
        
        const games = wins + losses + ties;
        const winPct = games > 0 ? (wins + (ties * 0.5)) / games : 0;
        
        return {
          id: team.teamId,
          name: team.name,
          logo: team.logo,
          color: team.color,
          wins,
          losses,
          ties,
          record: `${wins}-${losses}${ties > 0 ? `-${ties}` : ''}`,
          winPct
        };
      } else {
        // For regular season, use the original method
        const scheduleRes = await fetch(
          `https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/teams/${team.teamId}/schedule?season=${seasonNum}&seasontype=2`
        );
        const scheduleData = await scheduleRes.json();
        
        // Calculate record from regular season games
        let wins = 0;
        let losses = 0;
        scheduleData.events?.forEach(event => {
          const teamInGame = event.competitions?.[0]?.competitors?.find(
            c => c.team?.id === team.teamId
          );
          if (teamInGame?.winner === true) wins++;
          else if (teamInGame?.winner === false) losses++;
        });
        
        const winPct = wins + losses > 0 ? wins / (wins + losses) : 0;
        
        return {
          id: team.teamId,
          name: team.name,
          logo: team.logo,
          color: team.color,
          wins,
          losses,
          ties: 0,
          record: `${wins}-${losses}`,
          winPct
        };
      }
    });

    const teams = await Promise.all(teamPromises);
    
    // Calculate win percentage properly including ties
    teams.forEach(team => {
      const games = team.wins + team.losses + team.ties;
      team.winPct = games > 0 ? (team.wins + (team.ties * 0.5)) / games : 0;
    });

    // Sort by win percentage
    const sortedTeams = teams.sort((a, b) => {
      if (b.winPct !== a.winPct) {
        return b.winPct - a.winPct;
      }
      // If win percentages are equal, sort by wins
      if (b.wins !== a.wins) {
        return b.wins - a.wins;
      }
      // If wins are equal, sort by fewer losses
      return a.losses - b.losses;
    });
    
    // Add position and standing summary, handling ties
    let currentPosition = 1;
    let currentWinPct = -1;
    let skippedPositions = 0;

    return sortedTeams.map((team, index) => {
      // If this is the first team or if this team has a different win percentage than the previous team
      if (index === 0 || team.winPct !== sortedTeams[index - 1].winPct) {
        currentPosition = index + 1;
        currentWinPct = team.winPct;
      }

      const suffix = currentPosition === 1 ? 'st' : currentPosition === 2 ? 'nd' : currentPosition === 3 ? 'rd' : 'th';
      return {
        ...team,
        standingSummary: `${currentPosition}${suffix} in ${divisionName}`
      };
    });
  } catch (error) {
    console.error('Error fetching division standings:', error);
    return [];
  }
}

export async function getSchedule(teamId, season) {
  try {
    // Fetch spring training games
    const springRes = await fetch(
      `https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/teams/${teamId}/schedule?season=${season}&seasontype=1`
    );
    const springData = await springRes.json();

    // Fetch regular season games
    const regularRes = await fetch(
      `https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/teams/${teamId}/schedule?season=${season}&seasontype=2`
    );
    const regularData = await regularRes.json();

    // Fetch postseason games
    const postRes = await fetch(
      `https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/teams/${teamId}/schedule?season=${season}&seasontype=3`
    );
    const postData = await postRes.json();

    return {
      events: [
        // Spring Training games
        ...(springData.events?.map(event => ({
          id: event.id,
          date: new Date(event.date),
          name: event.name,
          shortName: event.shortName,
          isSpringTraining: true,
          competitions: event.competitions?.map(comp => ({
            competitors: comp.competitors?.map(team => ({
              homeAway: team.homeAway,
              team: {
                name: team.team?.displayName || team.team?.name,
                logo: team.team?.logo || `https://a.espncdn.com/i/teamlogos/mlb/500/${team.team?.abbreviation?.toLowerCase()}.png`,
                id: team.team?.id
              }
            }))
          }))?.[0]
        })) || []),
        // Regular Season games
        ...(regularData.events?.map(event => ({
          id: event.id,
          date: new Date(event.date),
          name: event.name,
          shortName: event.shortName,
          isSpringTraining: false,
          competitions: event.competitions?.map(comp => ({
            competitors: comp.competitors?.map(team => ({
              homeAway: team.homeAway,
              team: {
                name: team.team?.displayName || team.team?.name,
                logo: team.team?.logo || `https://a.espncdn.com/i/teamlogos/mlb/500/${team.team?.abbreviation?.toLowerCase()}.png`,
                id: team.team?.id
              }
            }))
          }))?.[0]
        })) || []),
        // Postseason games
        ...(postData.events?.map(event => ({
          id: event.id,
          date: new Date(event.date),
          name: event.name,
          shortName: event.shortName,
          isSpringTraining: false,
          competitions: event.competitions?.map(comp => ({
            competitors: comp.competitors?.map(team => ({
              homeAway: team.homeAway,
              team: {
                name: team.team?.displayName || team.team?.name,
                logo: team.team?.logo || `https://a.espncdn.com/i/teamlogos/mlb/500/${team.team?.abbreviation?.toLowerCase()}.png`,
                id: team.team?.id
              }
            }))
          }))?.[0]
        })) || [])
      ]
        // Remove duplicates based on event ID
        .filter((event, index, self) => 
          index === self.findIndex((e) => e.id === event.id)
        )
        // Sort by date
        .sort((a, b) => a.date - b.date)
    };
  } catch (error) {
    console.error('Error fetching schedule:', error);
    return { events: [] };
  }
}

// Helper function to convert team name to URL slug
export function teamNameToSlug(name) {
  return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
}

// Helper function to get team by slug
export function getTeamBySlug(slug) {
  return ALL_TEAMS.find(team => teamNameToSlug(team.name) === slug);
}

// Helper function to get team by ID
export function getTeamById(id) {
  return ALL_TEAMS.find(team => team.teamId === id);
}

// Add slug to each team
AL_EAST_TEAMS.forEach(team => {
  team.slug = teamNameToSlug(team.name);
});

AL_CENTRAL_TEAMS.forEach(team => {
  team.slug = teamNameToSlug(team.name);
});

AL_WEST_TEAMS.forEach(team => {
  team.slug = teamNameToSlug(team.name);
});

NL_EAST_TEAMS.forEach(team => {
  team.slug = teamNameToSlug(team.name);
});

NL_CENTRAL_TEAMS.forEach(team => {
  team.slug = teamNameToSlug(team.name);
});

NL_WEST_TEAMS.forEach(team => {
  team.slug = teamNameToSlug(team.name);
});

// Helper function to check if we're past opening day for a given season
export function isPastOpeningDay(season) {
  // Opening day for 2025 was March 27
  const openingDay = new Date(2025, 2, 27); // Month is 0-based, so 2 = March
  const today = new Date();
  
  return today > openingDay;
}

// Helper function to fetch live game details
export async function getLiveGameDetails(gameId) {
  try {
    const res = await fetch(`https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/summary?event=${gameId}`);
    const data = await res.json();
    return data;
  } catch (error) {
    console.error('Error fetching live game details:', error);
    return null;
  }
} 